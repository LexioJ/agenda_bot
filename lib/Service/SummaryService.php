<?php

declare(strict_types=1);
/**
 * SPDX-FileCopyrightText: 2025 Agenda Bot Contributors
 * SPDX-License-Identifier: AGPL-3.0-or-later
 */

namespace OCA\AgendaBot\Service;

use OCA\AgendaBot\AppInfo\Application;
use OCA\AgendaBot\Model\LogEntry;
use OCA\AgendaBot\Model\LogEntryMapper;
use OCP\AppFramework\Utility\ITimeFactory;
use OCP\IConfig;
use OCP\L10N\IFactory;

class SummaryService {

	public function __construct(
		protected LogEntryMapper $logEntryMapper,
		protected ITimeFactory $timeFactory,
		protected IConfig $config,
		protected AgendaService $agendaService,
		protected IFactory $l10nFactory,
		protected TimingUtilityService $timingUtilityService,
		protected RoomConfigService $roomConfigService,
	) {
	}

	public function processMessage(string $message, array $data): bool {
		$token = $data['target']['id'] ?? '';
		if (!$token) {
			return false;
		}

		// Note: Agenda items are now handled directly in BotInvokeListener
		// This method only handles general message logging

		// Log as a general message
		$entry = new LogEntry();
		$entry->setServer('local');
		$entry->setToken($token);
		$entry->setType(LogEntry::TYPE_MESSAGE);
		$entry->setDetails(json_encode([
			'message' => $message,
			'actor_type' => $data['actor']['type'] ?? 'unknown',
			'actor_id' => $data['actor']['id'] ?? 'unknown',
			'message_type' => 'comment'
		], JSON_THROW_ON_ERROR));
		$this->logEntryMapper->insert($entry);

		return true;
	}

	public function generateAgendaSummary(string $token, string $conversation, string $lang = 'en'): ?array {
		$l = $this->l10nFactory->get(Application::APP_ID, $lang);
		$emojis = $this->roomConfigService->getEmojisConfig($token);
		$agendaData = $this->agendaService->exportAgenda($token);
		
		if ($agendaData['total'] === 0) {
			return null;
		}

		$summary = "## ðŸ“‹ " . $l->t('Meeting Agenda Summary') . "\n\n";
		$summary .= "**" . $l->t('Topic:') . "** " . $conversation . "\n";
		
		// Add timing summary right after topic
		$timingSummary = $this->generateMeetingTimingSummary($agendaData, $lang);
		if (!empty($timingSummary)) {
			$summary .= $timingSummary . "\n";
		}
		
		$summary .= "**" . $l->t('Total Agenda Items:') . "** " . $agendaData['total'] . "\n";
		
		// Enhanced completed section with timing percentages
		if ($agendaData['completed'] > 0) {
			$timingStats = $agendaData['timing_stats'];
			$summary .= "**" . $l->t('Completed:') . "** " . $l->t('%d (%d%% %s / %d%% %s)', [
				$agendaData['completed'],
				$timingStats['in_time_percentage'],
				$emojis['on_time'],
				$timingStats['overdue_percentage'],
				$emojis['time_warning']
			]) . "\n";
		} else {
			$summary .= "**" . $l->t('Completed:') . "** " . $agendaData['completed'] . "\n";
		}
		
		$summary .= "**" . $l->t('Remaining:') . "** " . $agendaData['incomplete'] . "\n\n";

		if (!empty($agendaData['completed_items_with_timing'])) {
			$summary .= "#### " . $emojis['completed'] . " " . $l->t('Completed Items') . "\n";
			foreach ($agendaData['completed_items_with_timing'] as $item) {
				$plannedDuration = $item['duration'];
				$timeDiff = $item['time_diff'];
				$isOverdue = $item['is_overdue'];
				
				// Format timing display: planned+diff or planned-diff
				if ($timeDiff > 0) {
					$timingDisplay = $l->t('(%d+%d min)', [$plannedDuration, $timeDiff]);
					$statusIcon = " " . $emojis['time_warning'];
				} elseif ($timeDiff < 0) {
					$timingDisplay = $l->t('(%d%d min)', [$plannedDuration, $timeDiff]); // negative diff
					$statusIcon = " " . $emojis['on_time'];
				} else {
					$timingDisplay = $l->t('(%d min)', [$plannedDuration]);
					$statusIcon = " " . $emojis['on_time'];
				}
				
				$summary .= $item['position'] . ". " . $item['title'] . " " . $timingDisplay . $statusIcon . "\n";
			}
			$summary .= "\n";
		}

		if (!empty($agendaData['incomplete_items'])) {
			$summary .= "#### " . $emojis['pending'] . " " . $l->t('Remaining Items') . "\n";
			foreach ($agendaData['incomplete_items'] as $item) {
				$summary .= $item['position'] . ". " . $item['title'] . " (" . $item['duration'] . " " . $l->t('min') . ")\n";
			}
			$summary .= "\n";
		}

		$summary .= "---\n";
		$summary .= "_" . $l->t('Generated by Agenda bot') . " ðŸ¤–_";
		
		// Add cleanup question if there are completed items
		if ($agendaData['completed'] > 0) {
			$summary .= "\n\nðŸ§¹ **" . $l->t('Remove completed items from agenda?') . "**\n";
			$summary .= "*" . $l->t("Moderators/Owners: Reply with 'agenda cleanup' or react with ðŸ‘, âœ…, or ðŸ§¹") . "*";
		}

		return [
			'summary' => $summary,
			'agenda_data' => $agendaData,
		];
	}

	public function logAttendee(string $token, string $attendee): void {
		$entry = new LogEntry();
		$entry->setServer('local');
		$entry->setToken($token);
		$entry->setType(LogEntry::TYPE_ATTENDEE);
		$entry->setDetails($attendee);
		$this->logEntryMapper->insert($entry);
	}

	public function logCallStart(string $token): void {
		$entry = new LogEntry();
		$entry->setServer('local');
		$entry->setToken($token);
		$entry->setType(LogEntry::TYPE_START);
		$entry->setDetails((string)$this->timeFactory->now()->getTimestamp());
		$this->logEntryMapper->insert($entry);
	}

	public function logCallEnd(string $token): void {
		$entry = new LogEntry();
		$entry->setServer('local');
		$entry->setToken($token);
		$entry->setType(LogEntry::TYPE_END);
		$entry->setDetails((string)$this->timeFactory->now()->getTimestamp());
		$this->logEntryMapper->insert($entry);
	}

	/**
	 * Generate timing summary for meeting summary page
	 */
	private function generateMeetingTimingSummary(array $agendaData, string $lang): string {
		if (empty($agendaData['items'])) {
			return '';
		}
		
		// Calculate total planned time
		$totalPlannedMinutes = array_sum(array_column($agendaData['items'], 'duration'));
		
		// Calculate actual time using utility service
		$timingData = $this->timingUtilityService->calculateCompletedActualTime($agendaData['completed_items_with_timing']);
		
		// Generate timing summary string using utility service (multi-line for readable summaries)
		return $this->timingUtilityService->generateTimingSummaryString(
			$totalPlannedMinutes,
			$timingData['total_actual_minutes'],
			$timingData['has_actual_time'],
			$lang,
			'',
			'',
			true, // bold formatting for meeting summaries
			true  // multi-line format for summaries
		);
	}

}
